//@version=5
strategy("4H Vegas Channel Strategy Enhanced v2.0",
         overlay=true,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=20)

// ============================================================================
// 第一部分: 内联库函数
// ============================================================================

// 计算5条EMA指标
f_calculate_emas(int len12, int len144, int len156, int len565, int len676) =>
    [ta.ema(close, len12), ta.ema(close, len144), ta.ema(close, len156), ta.ema(close, len565), ta.ema(close, len676)]

// 检测空头趋势: ema12 < min(ema144, ema156) < min(ema565, ema676)
f_is_downtrend(float ema12, float ema144, float ema156, float ema565, float ema676) =>
    ema12 < math.min(ema144, ema156) and math.min(ema144, ema156) < math.min(ema565, ema676)

// 计算线性回归斜率 (转换为角度)
f_calculate_slope(float source, int period) =>
    if bar_index < period
        0.0
    else
        x_sum = 0.0
        y_sum = 0.0
        xy_sum = 0.0
        x2_sum = 0.0
        for i = 0 to period - 1
            x = float(i)
            y = source[i]
            x_sum += x
            y_sum += y
            xy_sum += x * y
            x2_sum += x * x
        n = float(period)
        numerator = n * xy_sum - x_sum * y_sum
        denominator = n * x2_sum - x_sum * x_sum
        slope = denominator != 0 ? numerator / denominator : 0.0
        math.atan(slope) * 180.0 / math.pi

// 记录价格到数组
f_record_price(float price, float threshold, array<float> high_arr, array<float> low_arr, int capacity) =>
    if price > threshold
        array.push(high_arr, price)
    else
        array.push(low_arr, price)

    // 循环队列管理: 超过容量则删除最早数据
    if array.size(high_arr) > capacity
        array.shift(high_arr)
    if array.size(low_arr) > capacity
        array.shift(low_arr)

// 计算移动止损
f_calculate_trailing_sl(bool is_long, float entry_price, array<float> high_arr, array<float> low_arr, int threshold) =>
    total_count = array.size(high_arr) + array.size(low_arr)
    if total_count <= threshold
        entry_price
    else
        if is_long
            if array.size(high_arr) < array.size(low_arr)
                entry_price
            else
                sum = 0.0
                for i = 0 to array.size(low_arr) - 1
                    sum += array.get(low_arr, i)
                sum / array.size(low_arr)
        else
            if array.size(high_arr) > array.size(low_arr)
                entry_price
            else
                sum = 0.0
                for i = 0 to array.size(high_arr) - 1
                    sum += array.get(high_arr, i)
                sum / array.size(high_arr)

// 检查价格是否接近指定EMA (容差范围)
f_check_price_near_ema(float price, float ema, float offset_percent) =>
    price >= ema * (1 - offset_percent / 100) and price <= ema * (1 + offset_percent / 100)

// 检查价格是否在多个EMA范围内 (用于空单)
f_check_entry_price_short(float price, float ema144, float ema150, float ema156, float ema565, float ema600, float offset_percent) =>
    (f_check_price_near_ema(price, ema144, offset_percent) or
     f_check_price_near_ema(price, ema150, offset_percent) or
     f_check_price_near_ema(price, ema156, offset_percent) or
     f_check_price_near_ema(price, ema565, offset_percent) or
     f_check_price_near_ema(price, ema600, offset_percent))

// ============================================================================
// 第二部分: 参数定义
// ============================================================================

// 趋势与斜率参数
SLOPE_THRESHOLD = input(15.0, "EMA144 Slope Threshold (°)", group="Trend Parameters")
SLOPE_PERIOD = input(28, "Slope Calculation Period", group="Trend Parameters")

// 开仓参数
ENTRY_QTY = input(0.1, "Entry Position Size", group="Entry Parameters")
OFFSET_PERCENT = input(2.0, "Entry Price Offset (%)", group="Entry Parameters")
PRICE_ARRAY_THRESHOLD = input(8, "Price Collection Threshold (bars)", group="Entry Parameters")

// 止损止盈参数
SL_PERCENT = input(5.0, "Stop Loss (%)", group="Risk Management")
TP1_PERCENT = input(10.0, "Take Profit 1 (%)", group="Risk Management")
TP2_PERCENT = input(15.0, "Take Profit 2 (%)", group="Risk Management")
TP3_PERCENT = input(25.0, "Take Profit 3 (%)", group="Risk Management")

// 高级参数
QUEUE_CAPACITY = input(48, "Array Queue Capacity", group="Advanced")

// ============================================================================
// 第三部分: 指标计算
// ============================================================================

// 日线EMA (参考用)
ema12_d = request.security(syminfo.tickerid, "D", ta.ema(close, 12))
ema144_d = request.security(syminfo.tickerid, "D", ta.ema(close, 144))
ema156_d = request.security(syminfo.tickerid, "D", ta.ema(close, 156))
ema565_d = request.security(syminfo.tickerid, "D", ta.ema(close, 565))
ema676_d = request.security(syminfo.tickerid, "D", ta.ema(close, 676))

// 4H主EMA (5条)
[ema12, ema144, ema156, ema565, ema676] = f_calculate_emas(12, 144, 156, 565, 676)

// 4H额外EMA (用于空单)
ema150 = ta.ema(close, 150)
ema600 = ta.ema(close, 600)

// 趋势判断
downtrend = f_is_downtrend(ema12, ema144, ema156, ema565, ema676)

// 斜率计算
slope144 = f_calculate_slope(ema144, SLOPE_PERIOD)
slope_low = math.abs(slope144) < SLOPE_THRESHOLD   // 斜率低: 适合多头
slope_high = math.abs(slope144) > SLOPE_THRESHOLD  // 斜率高: 适合空头

// ============================================================================
// 第四部分: 状态变量
// ============================================================================

// 信号标记
var bool duo1_marked = false       // Duo1多单信号标记
var bool kong1_marked = false      // Kong1空单信号标记
var int ema12_cross_count = 0      // EMA12上穿EMA144计数

// 头寸信息
var float long_entry_price = 0.0   // 多单入场价
var float short_entry_price = 0.0  // 空单入场价

// 价格记录数组
var array<float> highprice = array.new<float>()  // 高于EMA12的收盘价
var array<float> lowprice = array.new<float>()   // 低于EMA12的收盘价

// 时间追踪
var int bars_since_entry = 0       // 入场后经过的K线数
var bool prev_crossover = false    // 前一根是否EMA12上穿
var bool prev_crossunder = false   // 前一根是否现价下穿 (备用)

// ============================================================================
// 第五部分: 交易逻辑 - 信号与开仓
// ============================================================================

// 记录EMA12与EMA144的交叉次数
if ta.crossover(ema12, ema144)
    if not prev_crossover
        ema12_cross_count += 1
prev_crossover := ta.crossover(ema12, ema144)

// --- Duo1 多单信号 ---
// 标记条件: 空头趋势 + EMA144斜率 < 15°
if not duo1_marked and downtrend and slope_low
    duo1_marked := true

// 开仓条件:
// 1. Duo1已标记
// 2. 现价上穿EMA144
// 3. EMA12已上穿EMA144超过1次 (避免首次上穿)
// 4. 价格在EMA12 ± OFFSET_PERCENT% 范围内
// 5. 当前无持仓
if duo1_marked and ta.crossover(close, ema144) and ema12_cross_count > 1 and strategy.position_size == 0
    if f_check_price_near_ema(close, ema12, OFFSET_PERCENT)
        long_entry_price := close
        strategy.entry("Long", strategy.long, qty=ENTRY_QTY)
        duo1_marked := false
        ema12_cross_count := 0
        array.clear(highprice)
        array.clear(lowprice)
        bars_since_entry := 0

// --- Kong1 空单信号 ---
// 标记条件: 空头趋势 + EMA144斜率 > 15°
if not kong1_marked and downtrend and slope_high
    kong1_marked := true

// 取消条件: 空头趋势破裂
if not downtrend
    kong1_marked := false

// 开仓条件:
// 1. Kong1已标记
// 2. 价格接近指定EMA (EMA144/150/156/565/600)
// 3. 现价下穿EMA144
// 4. 当前无持仓
if kong1_marked and strategy.position_size == 0
    if f_check_entry_price_short(close, ema144, ema150, ema156, ema565, ema600, OFFSET_PERCENT)
        if ta.crossunder(close, ema144)
            short_entry_price := close
            strategy.entry("Short1", strategy.short, qty=ENTRY_QTY)
            kong1_marked := false
            array.clear(highprice)
            array.clear(lowprice)
            bars_since_entry := 0

// ============================================================================
// 第六部分: 持仓管理 - 价格记录与移动止损
// ============================================================================

// 多单持仓管理
if strategy.position_size > 0 and not na(long_entry_price)
    bars_since_entry += 1

    // 记录价格 (根据EMA12分类)
    f_record_price(close, ema12, highprice, lowprice, QUEUE_CAPACITY)

    // 计算并执行移动止损
    trailing_sl = f_calculate_trailing_sl(true, long_entry_price, highprice, lowprice, PRICE_ARRAY_THRESHOLD)
    strategy.exit("SL_Long", "Long", stop=trailing_sl)

// 空单持仓管理
if strategy.position_size < 0 and not na(short_entry_price)
    bars_since_entry += 1

    // 记录价格 (根据EMA12分类)
    f_record_price(close, ema12, highprice, lowprice, QUEUE_CAPACITY)

    // 计算并执行移动止损
    trailing_sl = f_calculate_trailing_sl(false, short_entry_price, highprice, lowprice, PRICE_ARRAY_THRESHOLD)
    strategy.exit("SL_Short", "Short1", stop=trailing_sl)

// ============================================================================
// 第七部分: 止盈止损执行
// ============================================================================

// 多单止盈分层: 10%平50% → 15%平25% → 25%平100%
if strategy.position_size > 0
    if close > long_entry_price * (1 + TP3_PERCENT / 100)
        strategy.close("Long", comment="TP3 25%")
    else if close > long_entry_price * (1 + TP2_PERCENT / 100)
        strategy.close("Long", comment="TP2 25%")
    else if close > long_entry_price * (1 + TP1_PERCENT / 100)
        strategy.close("Long", comment="TP1 50%")

    // 固定止损
    sl = long_entry_price * (1 - SL_PERCENT / 100)
    strategy.exit("SL_Long", "Long", stop=sl)

// 空单止盈分层: 10%平50% → 15%平25% → 25%平100%
if strategy.position_size < 0
    if close < short_entry_price * (1 - TP3_PERCENT / 100)
        strategy.close("Short1", comment="TP3 25%")
    else if close < short_entry_price * (1 - TP2_PERCENT / 100)
        strategy.close("Short1", comment="TP2 25%")
    else if close < short_entry_price * (1 - TP1_PERCENT / 100)
        strategy.close("Short1", comment="TP1 50%")

    // 固定止损
    sl = short_entry_price * (1 + SL_PERCENT / 100)
    strategy.exit("SL_Short", "Short1", stop=sl)

// ============================================================================
// 第八部分: 可视化
// ============================================================================

// EMA绘制
plot(ema12, "EMA12", color.blue, linewidth=1)
plot(ema144, "EMA144", color.red, linewidth=1)
plot(ema156, "EMA156", color.orange, linewidth=1)
plot(ema565, "EMA565", color.purple, linewidth=1)
plot(ema676, "EMA676", color.teal, linewidth=1)

// 信号标记
plotshape(duo1_marked, title="Long Signal (Duo1)", location=location.abovebar,
          color=color.green, size=size.small, text="L")
plotshape(kong1_marked, title="Short Signal (Kong1)", location=location.belowbar,
          color=color.red, size=size.small, text="S")

// ============================================================================
// 第九部分: 信息面板
// ============================================================================

var table panel = na

f_update_panel() =>
    if na(panel)
        panel := table.new(position.top_right, 2, 12, border_color=color.gray, border_width=1)

    // 标题
    table.cell(panel, 0, 0, "4H Vegas Channel", bgcolor=color.navy, text_color=color.white, width=50)
    table.cell(panel, 1, 0, "值", bgcolor=color.navy, text_color=color.white, width=50)

    // 第1行: 4H趋势
    table.cell(panel, 0, 1, "趋势(4H)", text_color=color.white)
    table.cell(panel, 1, 1, downtrend ? "看空" : "中性", text_color=downtrend ? color.red : color.gray)

    // 第2行: EMA144斜率
    table.cell(panel, 0, 2, "EMA144斜率", text_color=color.white)
    table.cell(panel, 1, 2, str.tostring(math.round(slope144, 2)) + "°", text_color=color.white)

    // 第3行: Duo1状态
    table.cell(panel, 0, 3, "Duo1状态", text_color=color.white)
    table.cell(panel, 1, 3, duo1_marked ? "✓ 标记" : "✗ 等待", text_color=duo1_marked ? color.green : color.red)

    // 第4行: Kong1状态
    table.cell(panel, 0, 4, "Kong1状态", text_color=color.white)
    table.cell(panel, 1, 4, kong1_marked ? "✓ 标记" : "✗ 等待", text_color=kong1_marked ? color.green : color.red)

    // 第5行: EMA12交叉次数
    table.cell(panel, 0, 5, "EMA12上穿", text_color=color.white)
    table.cell(panel, 1, 5, str.tostring(ema12_cross_count) + "次", text_color=color.white)

    // 第6行: 持仓方向
    table.cell(panel, 0, 6, "持仓", text_color=color.white)
    pos_text = strategy.position_size > 0 ? "多头" : (strategy.position_size < 0 ? "空头" : "无")
    pos_color = strategy.position_size > 0 ? color.green : (strategy.position_size < 0 ? color.red : color.gray)
    table.cell(panel, 1, 6, pos_text, text_color=pos_color)

    // 第7行: 入场价
    table.cell(panel, 0, 7, "入场价", text_color=color.white)
    entry_text = strategy.position_size != 0 ?
        str.tostring(math.round(long_entry_price > 0 ? long_entry_price : short_entry_price, 4)) : "-"
    table.cell(panel, 1, 7, entry_text, text_color=color.white)

    // 第8行: 持有K线数
    table.cell(panel, 0, 8, "持有K线", text_color=color.white)
    table.cell(panel, 1, 8, str.tostring(bars_since_entry), text_color=color.white)

    // 第9行: 价格记录数
    table.cell(panel, 0, 9, "价格记录", text_color=color.white)
    table.cell(panel, 1, 9, str.tostring(array.size(highprice) + array.size(lowprice)), text_color=color.white)

    // 第10行: 日线趋势
    table.cell(panel, 0, 10, "日线趋势", text_color=color.white)
    downtrend_d = ema12_d < math.min(ema144_d, ema156_d)
    table.cell(panel, 1, 10, downtrend_d ? "看空" : "中性", text_color=downtrend_d ? color.red : color.gray)

// 更新信息面板
f_update_panel()
