背景：4h 维加斯通道。
定义：

ema12，ema144，ema156，ema565，ema676

空头趋势：
ema12< min(ema144，ema156)< min(ema565，ema676)

止盈策略：
1.固定止盈：
上涨10%，平仓50%
上涨15%，平仓25%
上涨25%，平仓25%

2.移动止盈

止损策略：
固定5%止损。
根据策略移动止损




开单逻辑：多单。
1.满足空头趋势并且ema144近28根k线，斜率小于25度
标记为 duo1  。不满足条件则取消标记
2.满足duo1，并且ema12上穿ema144时
在现价等于ema12的时候开多单。
duo1标记位取消。
3.开单后，记录收盘价。高于ema12则，价格加入highprice数组，低于ema12，则加入lowprice数组。
当len(highprice)+len(lowprice)>8时，移动止损为，lowprice平均值。
如果len(highprice)<len(lowprice),则移动止损为成本价。

开单后，取消标记duo1


开单逻辑：空单
1.满足空头趋势并且ema144近28根k线，斜率大于25度
标记为 空1
2.如果不满足空头趋势或者斜率不满足条件，取消空1标记
3.在空1条件下。当现价等于ema144，开空，仓位20%，当现价等于ema156，开空，仓位20%。
上面2单，止损为5%
开单后，取消空1标记
3.开单后，记录收盘价。高于ema12则，价格加入highprice数组，低于ema12，则加入lowprice数组。
当len(highprice)+len(lowprice)>8时，移动止损为，highprice平均值。
如果len(highprice)>len(lowprice),则移动止损为成本价。


用pine写上面的策略。并且尽量适用于tradingview
上面的逻辑尽量拆分为函数，以后可以给其他使用。
帮我写回测函数。