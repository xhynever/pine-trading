//@version=5
strategy("4H Vegas Channel Strategy - SHORT ONLY v1.0",
         overlay=true,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=20)

// ============================================================================
// 第一部分: 内联库函数
// ============================================================================

// 计算5条EMA指标
f_calculate_emas(int len12, int len144, int len156, int len565, int len676) =>
    [ta.ema(close, len12), ta.ema(close, len144), ta.ema(close, len156), ta.ema(close, len565), ta.ema(close, len676)]

// 检测空头趋势: ema12 < min(ema144, ema156) < min(ema565, ema676)
f_is_downtrend(float ema12, float ema144, float ema156, float ema565, float ema676) =>
    ema12 < math.min(ema144, ema156) and math.min(ema144, ema156) < math.min(ema565, ema676)

// 计算真实波幅指标 (ATR) - 反映市场波动性
f_calculate_volatility(int period) =>
    ta.atr(period)

// 记录价格到数组
f_record_price(float price, float threshold, array<float> high_arr, array<float> low_arr, int capacity) =>
    if price > threshold
        array.push(high_arr, price)
    else
        array.push(low_arr, price)

    // 循环队列管理: 超过容量则删除最早数据
    if array.size(high_arr) > capacity
        array.shift(high_arr)
    if array.size(low_arr) > capacity
        array.shift(low_arr)

// 计算移动止损 (仅处理空单)
f_calculate_trailing_sl_short(float entry_price, array<float> high_arr, array<float> low_arr, int threshold) =>
    total_count = array.size(high_arr) + array.size(low_arr)
    if total_count <= threshold
        entry_price
    else
        if array.size(high_arr) > array.size(low_arr)
            entry_price
        else
            if array.size(high_arr) == 0
                entry_price
            else
                sum = 0.0
                for i = 0 to array.size(high_arr) - 1
                    sum += array.get(high_arr, i)
                sum / array.size(high_arr)

// 检查价格是否接近指定EMA (容差范围)
f_check_price_near_ema(float price, float ema, float offset_percent) =>
    price >= ema * (1 - offset_percent / 100) and price <= ema * (1 + offset_percent / 100)

// 检查价格是否在多个EMA范围内 (用于空单)
f_check_entry_price_short(float price, float ema144, float ema150, float ema156, float ema565, float ema600, float offset_percent) =>
    (f_check_price_near_ema(price, ema144, offset_percent) or
     f_check_price_near_ema(price, ema150, offset_percent) or
     f_check_price_near_ema(price, ema156, offset_percent) or
     f_check_price_near_ema(price, ema565, offset_percent) or
     f_check_price_near_ema(price, ema600, offset_percent))

// ============================================================================
// 第二部分: 参数定义
// ============================================================================

// 趋势与波动率参数
// ATR_THRESHOLD: 波动率阈值
//   - ATR > 此值 = 波动高 (剧烈) → Kong1空单信号
//   建议值范围：80-150（根据币种和市场环境调整）
ATR_THRESHOLD = input(100.0, "ATR Volatility Threshold", group="Trend Parameters")

// ATR_PERIOD: ATR计算周期（K线根数）
//   - 默认14是标准值，反映最近14根K线的平均波幅
//   - 值越小越灵敏，值越大越平滑
ATR_PERIOD = input(14, "ATR Calculation Period", group="Trend Parameters")

// 开仓参数
ENTRY_QTY = input(0.1, "Entry Position Size", group="Entry Parameters")
OFFSET_PERCENT = input(2.0, "Entry Price Offset (%)", group="Entry Parameters")
PRICE_ARRAY_THRESHOLD = input(8, "Price Collection Threshold (bars)", group="Entry Parameters")

// 止损止盈参数
SL_PERCENT = input(5.0, "Stop Loss (%)", group="Risk Management")
TP1_PERCENT = input(10.0, "Take Profit 1 (%)", group="Risk Management")
TP2_PERCENT = input(15.0, "Take Profit 2 (%)", group="Risk Management")
TP3_PERCENT = input(25.0, "Take Profit 3 (%)", group="Risk Management")

// 高级参数
QUEUE_CAPACITY = input(48, "Array Queue Capacity", group="Advanced")

// ============================================================================
// 第三部分: 指标计算
// ============================================================================

// 日线EMA (参考用)
ema12_d = request.security(syminfo.tickerid, "D", ta.ema(close, 12))
ema144_d = request.security(syminfo.tickerid, "D", ta.ema(close, 144))
ema156_d = request.security(syminfo.tickerid, "D", ta.ema(close, 156))
ema565_d = request.security(syminfo.tickerid, "D", ta.ema(close, 565))
ema676_d = request.security(syminfo.tickerid, "D", ta.ema(close, 676))

// 4H主EMA (5条)
[ema12, ema144, ema156, ema565, ema676] = f_calculate_emas(12, 144, 156, 565, 676)

// 4H额外EMA (用于空单)
ema150 = ta.ema(close, 150)
ema600 = ta.ema(close, 600)

// 趋势判断
downtrend = f_is_downtrend(ema12, ema144, ema156, ema565, ema676)

// 真实波幅计算
// atr_value: 当前的ATR值，代表市场波动强度
//   波动高 (volatility_high)：当前市场波动剧烈，适合空单建仓
atr_value = f_calculate_volatility(ATR_PERIOD)
volatility_high = atr_value > ATR_THRESHOLD  // 波动率高: 适合空头

// ============================================================================
// 第四部分: 状态变量
// ============================================================================

// 信号标记
var bool kong1_marked = false      // Kong1空单信号标记

// 分批头寸管理 - 每批0.1仓位，独立止损
// 使用数组追踪多个头寸
var array<float> batch_entry_prices = array.new<float>()  // 各批入场价
var array<float> batch_sl_prices = array.new<float>()     // 各批止损价
var array<string> batch_ids = array.new<string>()         // 各批订单ID (Short_1, Short_2...)
var array<bool> batch_opened = array.new<bool>()          // 各批是否已开仓

// EMA条件ID列表
var array<string> ema_conditions = array.new<string>()    // EMA144, EMA150, EMA156, EMA565, EMA600
var array<float> ema_values = array.new<float>()          // 对应的EMA值
var array<bool> ema_triggered = array.new<bool>()         // 各EMA条件是否已触发开仓

// 价格记录数组
var array<float> highprice = array.new<float>()  // 高于EMA12的收盘价
var array<float> lowprice = array.new<float>()   // 低于EMA12的收盘价

// 时间追踪
var int bars_since_entry = 0       // 入场后经过的K线数

// ============================================================================
// 第五部分: 交易逻辑 - 信号与开仓
// ============================================================================

// 初始化EMA条件数组（全局一次）
if array.size(ema_conditions) == 0
    array.push(ema_conditions, "EMA144")
    array.push(ema_conditions, "EMA150")
    array.push(ema_conditions, "EMA156")
    array.push(ema_conditions, "EMA565")
    array.push(ema_conditions, "EMA600")

    // 同时初始化ema_values
    array.push(ema_values, ema144)
    array.push(ema_values, ema150)
    array.push(ema_values, ema156)
    array.push(ema_values, ema565)
    array.push(ema_values, ema600)

// 初始化ema_triggered数组（全局一次）
if array.size(ema_triggered) == 0
    array.push(ema_triggered, false)
    array.push(ema_triggered, false)
    array.push(ema_triggered, false)
    array.push(ema_triggered, false)
    array.push(ema_triggered, false)

// --- Kong1 空单信号 ---
// 标记条件: 空头趋势 + ATR波动率高 (> 阈值)
if not kong1_marked and downtrend and volatility_high
    kong1_marked := true

// 取消条件: 空头趋势破裂
if not downtrend
    kong1_marked := false

// ============================================================================
// 分批开仓逻辑
// ============================================================================
// Kong1标记后，根据价格接近各EMA情况，分批开仓0.1
// 每个EMA条件对应一批0.1仓位

if kong1_marked and array.size(ema_conditions) > 0
    // 更新EMA值
    array.set(ema_values, 0, ema144)
    array.set(ema_values, 1, ema150)
    array.set(ema_values, 2, ema156)
    array.set(ema_values, 3, ema565)
    array.set(ema_values, 4, ema600)

    // 遍历5个EMA条件
    for i = 0 to array.size(ema_conditions) - 1
        ema_val = array.get(ema_values, i)
        ema_name = array.get(ema_conditions, i)
        already_triggered = array.get(ema_triggered, i)

        // 检查价格是否接近该EMA（OFFSET_PERCENT容差范围内）
        // 且该条件还未触发过开仓
        price_in_range = f_check_price_near_ema(close, ema_val, OFFSET_PERCENT)

        if price_in_range and not already_triggered
            // 标记该EMA条件已触发
            array.set(ema_triggered, i, true)

            // 计算该批的开仓价和止损价
            batch_entry = close
            batch_sl = close * (1 + SL_PERCENT / 100)

            // 生成唯一的订单ID
            batch_id = "Short_" + str.tostring(i + 1)

            // 下单：0.1仓位，限价=当前价
            strategy.entry(batch_id, strategy.short, qty=ENTRY_QTY)

            // 记录到数组
            array.push(batch_entry_prices, batch_entry)
            array.push(batch_sl_prices, batch_sl)
            array.push(batch_ids, batch_id)
            array.push(batch_opened, true)

// 取消已触发的状态（趋势破裂时）
if not kong1_marked
    array.clear(ema_triggered)
    // 重新初始化为false
    array.push(ema_triggered, false)
    array.push(ema_triggered, false)
    array.push(ema_triggered, false)
    array.push(ema_triggered, false)
    array.push(ema_triggered, false)

    array.clear(batch_opened)
    array.clear(batch_entry_prices)
    array.clear(batch_sl_prices)
    array.clear(batch_ids)

// ============================================================================
// 第六部分: 持仓管理 - 独立止损
// ============================================================================

// 持仓管理：每根K线增加bar计数
if strategy.position_size < 0
    bars_since_entry += 1

// 为每个已开仓的批次设置止损
if array.size(batch_ids) > 0
    for i = 0 to array.size(batch_ids) - 1
        batch_id_val = array.get(batch_ids, i)
        sl_price = array.get(batch_sl_prices, i)

        // 为该批设置止损单
        strategy.exit("SL_" + batch_id_val, batch_id_val, stop=sl_price)

// ============================================================================
// 第七部分: 止盈止损执行
// ============================================================================

// 分批止盈逻辑：每批根据自己的入场价计算止盈
if array.size(batch_entry_prices) > 0
    for i = 0 to array.size(batch_entry_prices) - 1
        entry_price = array.get(batch_entry_prices, i)
        batch_id_val = array.get(batch_ids, i)

        // 三层止盈：触及时平仓该批
        if close < entry_price * (1 - TP3_PERCENT / 100)
            strategy.close(batch_id_val, comment="TP3 25%")
            array.remove(batch_entry_prices, i)
            array.remove(batch_sl_prices, i)
            array.remove(batch_ids, i)
            array.remove(batch_opened, i)
            break
        else if close < entry_price * (1 - TP2_PERCENT / 100)
            strategy.close(batch_id_val, comment="TP2 25%")
            array.remove(batch_entry_prices, i)
            array.remove(batch_sl_prices, i)
            array.remove(batch_ids, i)
            array.remove(batch_opened, i)
            break
        else if close < entry_price * (1 - TP1_PERCENT / 100)
            strategy.close(batch_id_val, comment="TP1 50%")
            array.remove(batch_entry_prices, i)
            array.remove(batch_sl_prices, i)
            array.remove(batch_ids, i)
            array.remove(batch_opened, i)
            break

// ============================================================================
// 第八部分: 可视化
// ============================================================================

// EMA绘制
plot(ema12, "EMA12", color.blue, linewidth=1)
plot(ema144, "EMA144", color.red, linewidth=1)
plot(ema156, "EMA156", color.orange, linewidth=1)
plot(ema565, "EMA565", color.purple, linewidth=1)
plot(ema676, "EMA676", color.teal, linewidth=1)

// 信号标记
plotshape(kong1_marked, title="Short Signal (Kong1)", location=location.belowbar,
          color=color.red, size=size.small, text="S")

// ============================================================================
// 第九部分: 信息面板
// ============================================================================

var table panel = na

// 初始化或更新信息面板
if na(panel)
    panel := table.new(position.top_right, 2, 13, border_color=color.gray, border_width=1)

// 标题
table.cell(panel, 0, 0, "4H SHORT ONLY", bgcolor=color.navy, text_color=color.white, width=50)
table.cell(panel, 1, 0, "值", bgcolor=color.navy, text_color=color.white, width=50)

// 第1行: 4H趋势
table.cell(panel, 0, 1, "趋势(4H)", text_color=color.white)
table.cell(panel, 1, 1, downtrend ? "看空" : "中性", text_color=downtrend ? color.red : color.gray)

// 第2行: ATR波动率
table.cell(panel, 0, 2, "ATR波动率", text_color=color.white)
table.cell(panel, 1, 2, str.tostring(math.round(atr_value, 2)), text_color=color.white)

// 第3行: Kong1状态
table.cell(panel, 0, 3, "Kong1状态", text_color=color.white)
table.cell(panel, 1, 3, kong1_marked ? "✓ 标记" : "✗ 等待", text_color=kong1_marked ? color.green : color.red)

// 第4行: 总持仓数量
table.cell(panel, 0, 4, "总持仓", text_color=color.white)
total_pos_text = str.tostring(array.size(batch_ids)) + "批 (0.1×" + str.tostring(array.size(batch_ids)) + ")"
pos_color = array.size(batch_ids) > 0 ? color.red : color.gray
table.cell(panel, 1, 4, total_pos_text, text_color=pos_color)

// 第5行: 已开仓批数详情
table.cell(panel, 0, 5, "已开仓", text_color=color.white)
if array.size(batch_ids) > 0
    batch_list = ""
    for i = 0 to math.min(array.size(batch_ids) - 1, 4)
        if i > 0
            batch_list := batch_list + ","
        batch_list := batch_list + array.get(batch_ids, i)
    table.cell(panel, 1, 5, batch_list, text_color=color.green)
else
    table.cell(panel, 1, 5, "-", text_color=color.gray)

// 第6行: 已触发的EMA条件
table.cell(panel, 0, 6, "触发EMA", text_color=color.white)
if kong1_marked and array.size(ema_conditions) > 0
    triggered_emas = ""
    for i = 0 to array.size(ema_triggered) - 1
        if array.get(ema_triggered, i)
            if triggered_emas != ""
                triggered_emas := triggered_emas + ","
            triggered_emas := triggered_emas + array.get(ema_conditions, i)
    table.cell(panel, 1, 6, triggered_emas != "" ? triggered_emas : "-", text_color=color.orange)
else
    table.cell(panel, 1, 6, "-", text_color=color.gray)

// 第7行: 持有K线数
table.cell(panel, 0, 7, "持有K线", text_color=color.white)
table.cell(panel, 1, 7, str.tostring(bars_since_entry), text_color=color.white)

// 第8行: 日线趋势
table.cell(panel, 0, 8, "日线趋势", text_color=color.white)
downtrend_d = ema12_d < math.min(ema144_d, ema156_d)
table.cell(panel, 1, 8, downtrend_d ? "看空" : "中性", text_color=downtrend_d ? color.red : color.gray)

// 第9行: EMA144显示
table.cell(panel, 0, 9, "EMA144", text_color=color.white)
table.cell(panel, 1, 9, str.tostring(math.round(ema144, 2)), text_color=color.blue)

// 第10行: EMA156显示
table.cell(panel, 0, 10, "EMA156", text_color=color.white)
table.cell(panel, 1, 10, str.tostring(math.round(ema156, 2)), text_color=color.orange)

// 第11行: 当前价
table.cell(panel, 0, 11, "当前价", text_color=color.white)
table.cell(panel, 1, 11, str.tostring(math.round(close, 2)), text_color=color.white)

// 第12行: 参数设置
table.cell(panel, 0, 12, "参数", text_color=color.white)
param_text = "SL:" + str.tostring(SL_PERCENT) + "% TP:" + str.tostring(TP1_PERCENT) + "%"
table.cell(panel, 1, 12, param_text, text_color=color.gray)
