//@version=5
strategy("4H Vegas Channel Downtrend Strategy",
         overlay=true,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=20)

// ============= EMA计算函数 =============
ema12 = ta.ema(close, 12)
ema144 = ta.ema(close, 144)
ema156 = ta.ema(close, 156)
ema565 = ta.ema(close, 565)
ema676 = ta.ema(close, 676)

// ============= 空头趋势检测 =============
downtrend_signal = ema12 < math.min(ema144, ema156) and
                   math.min(ema144, ema156) < math.min(ema565, ema676)

// ============= 斜率计算函数 =============
f_calculate_slope(source, period) =>
    if bar_index < period
        0.0
    else
        x_sum = 0.0
        y_sum = 0.0
        xy_sum = 0.0
        x2_sum = 0.0

        for i = 0 to period - 1
            x = float(i)
            y = source[i]
            x_sum += x
            y_sum += y
            xy_sum += x * y
            x2_sum += x * x

        n = float(period)
        numerator = n * xy_sum - x_sum * y_sum
        denominator = n * x2_sum - x_sum * x_sum

        slope = denominator != 0 ? numerator / denominator : 0.0
        degrees = math.atan(slope) * 180.0 / math.pi
        degrees

// ============= 斜率计算 =============
ema144_slope = f_calculate_slope(ema144, 28)
slope_below_25 = math.abs(ema144_slope) < 25
slope_above_25 = ema144_slope > 25

// ============= 信号标记变量 =============
var bool duo1_marked = false
var bool kong1_marked = false
var float entry_price = 0.0
var array<float> highprice = array.new<float>()
var array<float> lowprice = array.new<float>()
var float trailing_stop = 0.0

// ============= 价格记录和移动止损 =============
if strategy.position_size[1] == 0 and strategy.position_size != 0
    array.clear(highprice)
    array.clear(lowprice)

if strategy.position_size != 0
    if close > ema12
        array.push(highprice, close)
    else
        array.push(lowprice, close)

    total_count = array.size(highprice) + array.size(lowprice)
    if total_count > 8
        if strategy.position_size > 0
            if array.size(highprice) < array.size(lowprice)
                trailing_stop := entry_price
            else
                lowprice_sum = 0.0
                for i = 0 to array.size(lowprice) - 1
                    lowprice_sum += array.get(lowprice, i)
                trailing_stop := lowprice_sum / array.size(lowprice)
        else
            if array.size(highprice) > array.size(lowprice)
                trailing_stop := entry_price
            else
                highprice_sum = 0.0
                for i = 0 to array.size(highprice) - 1
                    highprice_sum += array.get(highprice, i)
                trailing_stop := highprice_sum / array.size(highprice)

// ============= 多单逻辑 =============
if not duo1_marked and downtrend_signal and slope_below_25
    duo1_marked := true

if duo1_marked and ta.crossover(ema12, ema144)
    entry_price := close
    strategy.entry("Long", strategy.long, qty=1)
    duo1_marked := false

// ============= 空单逻辑 =============
if not kong1_marked and downtrend_signal and slope_above_25
    kong1_marked := true

if kong1_marked
    if close == ema144 and strategy.position_size == 0
        entry_price := close
        strategy.entry("Short1", strategy.short, qty=0.5)

    if close == ema156
        strategy.entry("Short2", strategy.short, qty=0.5)
        kong1_marked := false

// 取消标记条件
if not downtrend_signal
    kong1_marked := false

// ============= 止盈止损 =============
if strategy.position_size > 0
    if close > entry_price * 1.25
        strategy.close_position("Long", qty_percent=25)
    else if close > entry_price * 1.15
        strategy.close_position("Long", qty_percent=25)
    else if close > entry_price * 1.10
        strategy.close_position("Long", qty_percent=50)

    strategy.exit("SL Long", "Long", stop=entry_price * 0.95)

if strategy.position_size < 0
    if close < entry_price * 0.75
        strategy.close_position("Short1", qty_percent=25)
        strategy.close_position("Short2", qty_percent=25)
    else if close < entry_price * 0.85
        strategy.close_position("Short1", qty_percent=25)
        strategy.close_position("Short2", qty_percent=25)
    else if close < entry_price * 0.90
        strategy.close_position("Short1", qty_percent=50)
        strategy.close_position("Short2", qty_percent=50)

    strategy.exit("SL Short", "Short1", stop=entry_price * 1.05)
    strategy.exit("SL Short", "Short2", stop=entry_price * 1.05)

// ============= 绘制指标 =============
plot(ema12, "EMA12", color.blue, linewidth=1)
plot(ema144, "EMA144", color.red, linewidth=1)
plot(ema156, "EMA156", color.orange, linewidth=1)
plot(ema565, "EMA565", color.purple, linewidth=1)
plot(ema676, "EMA676", color.teal, linewidth=1)

// 标记信号
plotshape(duo1_marked, title="Duo1 Mark", location=plotshape.abovebar, color=color.green, size=size.small)
plotshape(kong1_marked, title="Kong1 Mark", location=plotshape.belowbar, color=color.red, size=size.small)
