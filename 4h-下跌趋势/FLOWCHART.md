# 4H Vegas Channel 策略 - 完整流程图

## 1. 策略总体流程

```
每个K线柱 (每4小时更新)
    ↓
[1] 计算指标
    ├─ 计算5条EMA (4H): EMA12, EMA144, EMA156, EMA565, EMA676
    ├─ 计算EMA144斜率 (线性回归28根K线)
    ├─ 获取日线EMA (参考)
    └─ 获取额外EMA: EMA150, EMA600
    ↓
[2] 检测趋势信号
    ├─ 判断空头趋势: ema12 < min(ema144, ema156) < min(ema565, ema676)
    ├─ 判断斜率: 高于/低于阈值(15%)
    └─ 记录EMA12与EMA144的上穿次数
    ↓
[3] 判断是否有持仓
    ├─ 如果无持仓 → 执行[信号标记逻辑]
    └─ 如果有持仓 → 执行[持仓管理逻辑]
    ↓
[结束本根K线]
```

## 2. 信号标记逻辑 (无持仓时)

### 2.1 多单信号 (Duo1) - 流程

```
检查是否标记Duo1信号
    ↓
[条件检查]
    ├─ 空头趋势 = TRUE
    ├─ 斜率低 = TRUE (|斜率| < 15%)
    └─ Duo1标记 = FALSE (未标记)
    ↓
[全部满足?]
    ├─ YES → 标记 duo1_marked = TRUE
    └─ NO → 保持现状
```

### 2.2 空单信号 (Kong1) - 流程

```
检查是否标记Kong1信号
    ↓
[条件检查1: 开启Kong1]
    ├─ 空头趋势 = TRUE
    ├─ 斜率高 = TRUE (|斜率| > 15%)
    └─ Kong1标记 = FALSE (未标记)
    ↓
[条件检查2: 取消Kong1]
    ├─ 空头趋势 = FALSE
    └─ Kong1标记 = TRUE
    ↓
[全部条件评估后结果]
```

## 3. 开仓逻辑

### 3.1 多单开仓 (Duo1) - 详细流程

```
if Duo1标记 = TRUE
    ↓
[开仓前置条件检查]
    ├─ 现价上穿EMA144? (close > ema144)
    ├─ EMA12上穿次数 > 1? (ema12_cross_count > 1)
    ├─ 当前无持仓? (strategy.position_size == 0)
    └─ 全部满足 = TRUE
    ↓
[价格范围检查]
    ├─ 价格 >= EMA12 × (1 - 2%)
    └─ 价格 <= EMA12 × (1 + 2%)
    ↓
[开仓执行]
    ├─ 入场价 = 现价 (close)
    ├─ 开多仓 0.1手
    ├─ 清空价格数组
    ├─ 重置状态:
    │   ├─ duo1_marked = FALSE
    │   ├─ ema12_cross_count = 0
    │   └─ bars_since_entry = 0
    └─ 进入持仓管理阶段
```

### 3.2 空单开仓 (Kong1) - 详细流程

```
if Kong1标记 = TRUE and 当前无持仓
    ↓
[开仓价格条件检查]
    检查价格是否在以下任一EMA附近 (±2%):
    ├─ EMA144
    ├─ EMA150
    ├─ EMA156
    ├─ EMA565
    └─ EMA600

    价格接近条件 = TRUE
    ↓
[下跌触发条件]
    └─ 现价下穿EMA144? (close < ema144)
    ↓
[开仓执行]
    ├─ 入场价 = 现价 (close)
    ├─ 开空仓 0.1手
    ├─ 清空价格数组
    ├─ 重置状态:
    │   ├─ kong1_marked = FALSE
    │   └─ bars_since_entry = 0
    └─ 进入持仓管理阶段
```

## 4. 持仓管理逻辑

### 4.1 价格记录机制

```
持仓中的每根K线
    ↓
[价格分类]
    ├─ if 收盘价 > EMA12
    │   └─ 加入 highprice 数组
    └─ if 收盘价 < EMA12
        └─ 加入 lowprice 数组
    ↓
[数组大小管理 - 循环队列]
    ├─ if highprice.size > QUEUE_CAPACITY (48)
    │   └─ 删除最早的数据
    └─ if lowprice.size > QUEUE_CAPACITY (48)
        └─ 删除最早的数据
    ↓
[记录完成]
```

### 4.2 多单持仓管理 - 流程

```
持有多单中
    ↓
[步骤1: 价格记录]
    └─ 执行上述价格记录机制
    ↓
[步骤2: 移动止损计算]
    ├─ 总价格数 = highprice.size + lowprice.size
    ├─ if 总价格数 > PRICE_ARRAY_THRESHOLD (8)
    │   ├─ if highprice.size < lowprice.size
    │   │   └─ 移动止损 = 入场价 (防守)
    │   └─ else
    │       └─ 移动止损 = lowprice的平均值 (动态止损)
    │
    └─ 执行移动止损单
    ↓
[步骤3: 止盈止损检查]
    ├─ if 现价 > 入场价 × (1 + TP3%) → 平仓全部
    ├─ else if 现价 > 入场价 × (1 + TP2%) → 平仓25%
    ├─ else if 现价 > 入场价 × (1 + TP1%) → 平仓50%
    └─ else
        └─ 执行固定止损 (入场价 × (1 - SL%))
```

### 4.3 空单持仓管理 - 流程

```
持有空单中
    ↓
[步骤1: 价格记录]
    └─ 执行上述价格记录机制
    ↓
[步骤2: 移动止损计算]
    ├─ 总价格数 = highprice.size + lowprice.size
    ├─ if 总价格数 > PRICE_ARRAY_THRESHOLD (8)
    │   ├─ if highprice.size > lowprice.size
    │   │   └─ 移动止损 = 入场价 (防守)
    │   └─ else
    │       └─ 移动止损 = highprice的平均值 (动态止损)
    │
    └─ 执行移动止损单
    ↓
[步骤3: 止盈止损检查]
    ├─ if 现价 < 入场价 × (1 - TP3%) → 平仓全部
    ├─ else if 现价 < 入场价 × (1 - TP2%) → 平仓25%
    ├─ else if 现价 < 入场价 × (1 - TP1%) → 平仓50%
    └─ else
        └─ 执行固定止损 (入场价 × (1 + SL%))
```

## 5. 指标计算详解

### 5.1 EMA计算
```
5条EMA计算 (4小时K线)
├─ EMA12 = ta.ema(close, 12)    [快线]
├─ EMA144 = ta.ema(close, 144)  [中线]
├─ EMA156 = ta.ema(close, 156)  [中线]
├─ EMA565 = ta.ema(close, 565)  [慢线]
└─ EMA676 = ta.ema(close, 676)  [慢线]

额外EMA (用于空单):
├─ EMA150 = ta.ema(close, 150)
└─ EMA600 = ta.ema(close, 600)
```

### 5.2 斜率计算 (线性回归)
```
使用最近28根K线的EMA144
    ↓
计算线性回归斜率:
    ├─ x = 0, 1, 2, ..., 27 (时间)
    ├─ y = EMA144[0], EMA144[1], ..., EMA144[27] (价格)
    ├─ 计算: slope = (n×Σxy - Σx×Σy) / (n×Σx² - (Σx)²)
    └─ 转换为角度: angle = arctan(slope) × 180 / π
    ↓
斜率判断:
    ├─ 斜率低 = |angle| < 15%
    └─ 斜率高 = |angle| > 15%
```

### 5.3 空头趋势判断
```
3个条件同时满足:
├─ EMA12 < EMA144 AND EMA12 < EMA156
│   └─ 快线在中线下方 (看空)
├─ EMA144 < EMA565 AND EMA144 < EMA676
│   └─ 中线在慢线下方 (看空)
└─ EMA156 < EMA565 AND EMA156 < EMA676
    └─ 另一条中线也在慢线下方 (看空)

结果: downtrend = TRUE/FALSE
```

## 6. 状态机转换图

```
[无持仓]
    ↓
[信号标记阶段]
├─ Duo1标记 = FALSE (初始)
├─ Kong1标记 = FALSE (初始)
└─ 等待信号触发
    ↓
[信号触发]
├─ 空头趋势 + 斜率条件
└─ Duo1或Kong1标记 = TRUE
    ↓
[开仓条件]
├─ 价格触发
├─ 交叉触发
└─ 其他条件
    ↓
[开仓执行]
├─ 建立多头/空头头寸
└─ 进入持仓管理
    ↓
[持仓管理]
├─ 记录价格
├─ 计算移动止损
├─ 检查止盈止损
└─ 更新头寸状态
    ↓
[平仓执行]
├─ 止盈触发
├─ 止损触发
├─ 移动止损触发
└─ 清空头寸状态
    ↓
[回到无持仓]
```

## 7. 参数对应关系

| 参数名 | 默认值 | 用途 | 相关逻辑 |
|--------|--------|------|---------|
| SLOPE_THRESHOLD | 15.0 | 斜率判断阈值 | 区分Duo1/Kong1 |
| SLOPE_PERIOD | 28 | 斜率计算周期 | EMA144线性回归 |
| PRICE_ARRAY_THRESHOLD | 8 | 移动止损触发数 | 价格记录达到8个启动 |
| QUEUE_CAPACITY | 48 | 数组最大容量 | 循环队列管理 |
| SL_PERCENT | 5.0 | 固定止损百分比 | 基础风险管理 |
| TP1_PERCENT | 10.0 | 第一止盈点(%) | 首次平仓50% |
| TP2_PERCENT | 15.0 | 第二止盈点(%) | 次次平仓25% |
| TP3_PERCENT | 25.0 | 第三止盈点(%) | 最终平仓25% |
| OFFSET_PERCENT | 2.0 | 价格偏移范围(%) | 开仓价格容差 |

## 8. 关键决策点

### Duo1 (多单) 触发条件
```
何时标记:
✓ 空头趋势 = TRUE
✓ 斜率低 (|angle| < 15%)
✓ Duo1标记 = FALSE

何时开仓:
✓ Duo1标记 = TRUE
✓ 现价上穿EMA144
✓ EMA12上穿次数 > 1
✓ 价格在EMA12±2%范围内
✓ 当前无持仓
```

### Kong1 (空单) 触发条件
```
何时标记:
✓ 空头趋势 = TRUE
✓ 斜率高 (|angle| > 15%)
✓ Kong1标记 = FALSE

何时开仓:
✓ Kong1标记 = TRUE
✓ 价格在指定EMA±2%范围内
✓ 现价下穿EMA144
✓ 当前无持仓

何时取消标记:
✗ 空头趋势 = FALSE
```

## 9. 交易信号示例

### 典型的Duo1 (多单) 交易
```
时间  |  事件                              | 信号状态      | 持仓状态
------|-----------------------------------|--------------|--------
t0   | 空头趋势形成，斜率 < 15%          | Duo1标记=TRUE | 无持仓
t0   | EMA12第一次上穿EMA144            | Duo1标记=TRUE | 无持仓
t1   | EMA12第二次上穿EMA144            | Duo1标记=TRUE | 无持仓
t2   | 现价上穿EMA144，价格在EMA12±2%   | →开仓        | →多头0.1
t3   | 价格继续上升，收盘>EMA12          | 记入highprice | 持仓中
...  | 价格收集达到8个                   | 激活移动止损  | 持仓中
...  | 现价上升10%                       | →平仓50%     | 减仓
...  | 现价上升15%                       | →平仓25%     | 减仓
...  | 现价上升25%                       | →平仓全部    | 无持仓
```

### 典型的Kong1 (空单) 交易
```
时间  |  事件                              | 信号状态      | 持仓状态
------|-----------------------------------|--------------|--------
t0   | 空头趋势形成，斜率 > 15%          | Kong1标记=TRUE| 无持仓
t1   | 价格靠近EMA144/150/156/565/600    | Kong1标记=TRUE| 无持仓
t2   | 现价下穿EMA144                    | →开仓        | →空头0.1
t3   | 价格继续下跌，收盘<EMA12          | 记入lowprice | 持仓中
...  | 价格收集达到8个                   | 激活移动止损  | 持仓中
...  | 现价下跌10%                       | →平仓50%     | 减仓
...  | 现价下跌15%                       | →平仓25%     | 减仓
...  | 现价下跌25%                       | →平仓全部    | 无持仓
```

## 10. 异常情况处理

```
场景1: 趋势反转
  空头趋势 → 中性/看多
  结果: Kong1标记自动取消，Duo1标记保留等待触发

场景2: 多次交叉
  EMA12与EMA144多次交叉
  结果: ema12_cross_count 持续计数，直到开仓重置

场景3: 价格不符合范围
  现价上穿EMA144，但价格超出EMA12±2%范围
  结果: 信号保留，等待下次符合范围的交叉

场景4: 同时满足两个信号
  不可能 (Duo1需要斜率<15%, Kong1需要斜率>15%)
```
